---
- name: Deploy CI/CD demo to k3s
  hosts: k8s
  become: yes
  vars:
    app_dir: /home/ubuntu/ci-cd-demo

  tasks:

    - name: Ensure app directory exists
      file:
        path: "{{ app_dir }}/k8s"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Template Kubernetes deployment file
      template:
        src: "{{ playbook_dir }}/../k8s/deployment.yaml.j2"
        dest: "{{ app_dir }}/k8s/deployment.yaml"
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Copy service.yaml
      copy:
        src: "{{ playbook_dir }}/../k8s/service.yaml"
        dest: "{{ app_dir }}/k8s/service.yaml"
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Apply Kubernetes manifests
      become_user: ubuntu
      shell: |
        sudo kubectl apply -f {{ app_dir }}/k8s/deployment.yaml
        sudo kubectl apply -f {{ app_dir }}/k8s/service.yaml
      args:
        executable: /bin/bash
